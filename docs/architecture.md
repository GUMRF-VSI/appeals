# Архитектура

------------------------------------------------------------------------------------------------------------------------

## Backend

------------------------------------------------------------------------------------------------------------------------

### DataBase

![Схема базы данных](./static/auth-service.png)

------------------------------------------------------------------------------------------------------------------------

### Основные сущности

#### Пользователь 

Описывает стандартного пользователя системы

| Название поля 	| Ссылается на 	| Тип ключа 	| Тип данных   	| Описание                                        	| Значение по умолчанию 	|
|---------------	|--------------	|-----------	|--------------	|-------------------------------------------------	|-----------------------	|
| <a id="user_id"></a>id            	|              	| PK        	| int          	| (unique) идентификатор                          	|                       	|
| <a id="email"></a>email         	|              	|           	| varchar(255) 	| (unique) email пользователя                     	|                       	|
| <a id="password"></a>password      	|              	|           	| string       	| пароль пользователя                             	|                       	|
| last_name     	|              	|           	| varchar(255) 	| (nullable) фамилия пользователя                 	|                       	|
| first_name    	|              	|           	| varchar(255) 	| (nullable) имя пользователя                     	|                       	|
| middle_name   	|              	|           	| varchar(255) 	| (nullable) отчество пользователя                	|                       	|
| is_active     	|              	|           	| boolean      	| ключ активности учетной записи                  	| true                  	|
| last_login    	|              	|           	| timestampz   	| время последнего входа в систему                	|                       	|
| created_at    	|              	|           	| timestampz   	| время создание учетной записи                   	|                       	|
| updated_at    	|              	|           	| timestampz   	| время последнего редактирования учетной записи  	|                       	|

#### Роль

Описывает стандартную роль системы

| Название поля 	| Ссылается на 	| Тип ключа 	| Тип данных   	| Описание                                       	| Значение по умолчанию 	|
|---------------	|--------------	|-----------	|--------------	|------------------------------------------------	|-----------------------	|
| id            	|              	| PK        	| int          	| (unique) идентификатор                         	|                       	|
| name          	|              	|           	| varchar(255) 	| человекочитаемое название роли                 	|                       	|

#### Право

Описывает стандартное право системы

| Название поля 	| Ссылается на 	| Тип ключа 	| Тип данных   	| Описание                                       	| Значение по умолчанию 	|
|---------------	|--------------	|-----------	|--------------	|------------------------------------------------	|-----------------------	|
| id            	|              	| PK        	| int          	| (unique) идентификатор                         	|                       	|
| name          	|              	|           	| varchar(255) 	| человекочитаемое название роли                 	|                       	|
| action_id     	| [action](#action)       	| FK        	| int          	| действие, производимое над object              	|                       	|
| object_id     	| [object](#object)       	| FK        	| int          	| объект доступа                                 	|                       	|


#### <a id="object"></a>Объект доступа

Описывает стандартный объект доступа системы. Объект системы создается для идентификации классов системы, чтобы определять права доступа к определенному функционалу системы. Является справочным объектом и не изменяется с помощью запросов. Создается на этапе проектирования

| Название поля 	| Ссылается на 	| Тип ключа 	| Тип данных   	| Описание                                       	| Значение по умолчанию 	|
|---------------	|--------------	|-----------	|--------------	|------------------------------------------------	|-----------------------	|
| id            	|              	| PK        	| int          	| (unique) Идентификатор                         	|                       	|
| name          	|              	|           	| varchar(255) 	| человекочитаемое название объекта              	|                       	|
| code          	|              	|           	| int          	| Машинное название объекта                      	|                       	|


#### <a id="action"></a>Действие над объектом доступа

Описывает стандартный действие над объектом доступа доступа системы. Действие системы создается для идентификации методов объектов системы, чтобы определять права доступа к определенному функционалу системы. Является справочным объектом и не изменяется с помощью запросов. Создает на этапе проектирования

| Название поля 	| Ссылается на 	| Тип ключа 	| Тип данных   	| Описание                                       	| Значение по умолчанию 	|
|---------------	|--------------	|-----------	|--------------	|------------------------------------------------	|-----------------------	|
| id            	|              	| PK        	| int          	| (unique) Идентификатор                         	|                       	|
| name          	|              	|           	| varchar(255) 	| человекочитаемое название действия              	|                       	|
| code          	|              	|           	| int          	| Машинное название действия                      	|                       	|


------------------------------------------------------------------------------------------------------------------------

### Функции системы

1. Авторизация пользователя:

    Авторизация пользователя представляет через Token Based Authentication, который обычно применяется при построении систем Single sign-on (SSO). При его использовании запрашиваемый сервис делегирует функцию проверки достоверности сведений о пользователе другому сервису. 

    1. Терминология

    #### Клиент

    Client — устройство или программа (браузер, приложение), которым требуется либо токен для аутентификации пользователя, либо токен для доступа к какому-то ресурсу

    #### Пользователь

    User — собственно конечный пользователь — человек.

    #### Область 

    Scope — идентификатор ресурса, к которому клиент хочет получить доступ. 

    Области бывают двух видов:

    Identity scopes — это запрос информации о пользователе. Его имя, профиль, пол, фотография, адрес электронной почты и так далее.
    
    Resource scopes — имена внешних ресурсо (Web APIs), к которым клиент хочет получить доступ.

    #### Запрос на аунтефикацию 

    Authentication/Token Request — процесс запроса аутентификации.

    #### <a id="identity"></a>Токен личности

    Identity Token — подтверждение аутентификации. Этот токен содержит минимальный набор информации о пользователе.

    #### <a id="access"></a>Токен доступа

    Access Token — информация, что конкретному пользователю разрешается делать. Клиент запрашивает Access Token и затем использует его для доступа к ресурсам (Web APIs). Access Token содержит информацию о клиенте и пользователе, если она присутствует.

    #### <a id="refresh"></a>Токен обновления 

    Refresh Token — токен, по которому сервис вернет новый Access Token.

    2. Этапы
        1. Пользователь обращается к системе
        2. Контроллер приложения перенаправляет запрос в класс представления
        3. Класс представления обращается к сервису авторизация
            1. Производится идентификация пользователя (метод определения, что за пользователь обращается к системе). Если пользователь есть в системе обращается к 2 пункту, в ином случае происходит ошибка.
            2. Производится аунтификация пользователя (метод определения, что пользователь является тем, за кого себя выдает). Если пользователь ввел данные верно обращаемся к 3 пункту, в ином случае происходит ошибка.
            3. Производится авторизация пользователя (метод принятия решение о том, что можно делать данному пользователю системы).
            4. Происходит генерация токенов.
        4. Класс представление возвращает ответ пользователю
    3. Конечные методы
        1. POST /api/v1/auth/authorize

            Используется для авторизации пользователя по **[email](#email)** и **[password](#password)**

            Тело запроса:
            | Поле     	| Тип    	| Описание            	|
            |----------	|--------	|---------------------	|
            | [email](#email)    	| string 	| email пользователя  	|
            | [password](#password) 	| string 	| пароль пользователя 	|

            Схема:

            ```json
            {
                email: string,
                password: string,
            }
            ```

            Тело ответа:

            1. Успешный запрос

                | Поле        	| Тип    	| Описание                         	|
                |-------------	|--------	|----------------------------------	|
                | [identity](#identity)    	| string 	| токен личности в формате [JWT](https://jwt.io/)               	|
                | [refresh](#refresh)      	| string 	| токен обновления в формате [JWT](https://jwt.io/)              	|
                |  [access](#access)     	| string 	| токен доступа в формате [JWT](https://jwt.io/)  	|

                Схема:

                ```json
                {
                    identity: string,
                    refresh: string,
                    access: string,
                }
                ```

            2. Неуспешный запрос

                | Поле    	| Тип    	| Описание                          	|
                |---------	|--------	|-----------------------------------	|
                | code    	| int    	| код ошибки                        	|
                | message 	| string 	| человекочитаемое сообщение ошибки 	|

                Схема:

                ```json
                {
                    code: number,
                    message: string,
                }
                ```
        2. POST /api/v1/auth/refresh

            Используется для получения новой тройки токенов

            Тело запроса:

            | Поле    	| Тип    	| Описание                          	|
            |---------	|--------	|-----------------------------------	|
            | [refresh](#refresh) 	| string 	| refresh токен                     	|

            Тело ответа:

            1. Успешный запрос:

                | Поле        	| Тип    	| Описание                         	|
                |-------------	|--------	|----------------------------------	|
                | [identity](#identity)    	| string 	| токен личности в формате [JWT](https://jwt.io/)               	|
                | [refresh](#refresh)      	| string 	| токен обновления в формате [JWT](https://jwt.io/)              	|
                |  [access](#access)     	| string 	| токен доступа в формате [JWT](https://jwt.io/)  	|

                Схема:

                ```json
                {
                    identity: string,
                    refresh: string,
                    access: string,
                }
                ```

            2. Неуспешный запрос

                | Поле    	| Тип    	| Описание                          	|
                |---------	|--------	|-----------------------------------	|
                | code    	| int    	| код ошибки                        	|
                | message 	| string 	| человекочитаемое сообщение ошибки 	|

                Схема:

                ```json
                {
                    code: number,
                    message: string,
                }
                ```

2. Регистрация пользователя:

    Регистраиця пользователя производится только пользователями с определенными правами ("user_create").

    1. Терминология

        Users - таблица в базе данных, содержащая всех пользователей системы

    2. Этапы
        1. Пользователь обращается к системе
        2. Контроллер приложения перенаправляет запрос в класс представления
            1. Проверяется, есть ли права у пользователя на регистрацию нового пользователя в системе. Если прав достаточно, то обращаемся к пункту 2, в ином случае происходит ошибка.
            2. В таблице **Users** создается запись с новым пользователем
        3. Класс представление возвращает ответ пользователю

    3. Конечные методы

        1. POST /api/v1/registration/register

            Используется для регистрации новых пользователей

            Тело запроса:

            | Поле        	| Тип    	| Описание                         	|
            |-------------	|--------	|----------------------------------	|
            | email       	| string 	| email пользователя               	|
            | password    	| string 	| пароль пользователя              	|
            | last_name   	| string 	| (nullable) фамилия пользователя  	|
            | first_name  	| string 	| (nullable) имя пользователя      	|
            | middle_name 	| string 	| (nullable) отчество пользователя 	|

            Схема:

             ```json
            {
                email: string,
                password: string,
                last_name: string | null,
                first_name: string | null,
                middle_name: string | null,
            }
            ```

            Тело ответа:

            1. Успешный запрос:

                Тело отсутсвуте

            2. Неуспешный запрос

                | Поле    	| Тип    	| Описание                          	|
                |---------	|--------	|-----------------------------------	|
                | code    	| int    	| код ошибки                        	|
                | message 	| string 	| человекочитаемое сообщение ошибки 	|

                Схема:

                ```json
                {
                    code: number,
                    message: string,
                }
                ```

3. Редактирование данных пользовотеля

    Редактирование пользователя производится только пользователями с определенными правами ("user_edit").

    1. Терминология

        Users - таблица в базе данных, содержащая всех пользователей системы

    2. Этапы
        1. Пользователь обращается к системе
        2. Контроллер приложения перенаправляет запрос в класс представления
            1. Проверяется, есть ли права у пользователя на изменение данных о пользователе в системе. Если прав достаточно, то обращаемся к пункту 2, в ином случае происходит ошибка.
            2. В таблице **Users** изменяется пользователь.
        3. Класс представление возвращает ответ пользователю
    3. Конечные методы

        1. PATCH /api/v1/user/update/{user_id}/

            Параметры запроса:

            | Поле        	| Тип    	| Описание                         	|
            |-------------	|--------	|----------------------------------	|
            | [user_id](#user_id)     	| int    	| идентификатор пользователя       	|

            Тело запроса:

            | Поле        	| Тип    	| Описание                         	|
            |-------------	|--------	|----------------------------------	|
            | email       	| string 	| email пользователя               	|
            | password    	| string 	| пароль пользователя              	|
            | last_name   	| string 	| (nullable) фамилия пользователя  	|
            | first_name  	| string 	| (nullable) имя пользователя      	|
            | middle_name 	| string 	| (nullable) отчество пользователя 	|

            Схема:

             ```json
            {
                email: string,
                password: string,
                last_name: string | null,
                first_name: string | null,
                middle_name: string | null,
            }
            ```

            Тело ответа:

            1. Успешный запрос:

                | Поле        	| Тип        	| Описание                                       	|
                |-------------	|------------	|------------------------------------------------	|
                | id          	| int        	| идентификатор                                  	|
                | email       	| string     	| email пользователя                             	|
                | last_name   	| string     	| (nullable) фамилия пользователя                	|
                | first_name  	| string     	| (nullable) имя пользователя                    	|
                | middle_name 	| string     	| (nullable) отчество пользователя               	|
                | is_active   	| boolean    	| ключ активности учетной записи                 	|
                | last_login  	| timestampz 	| время последнего входа в систему               	|
                | created_at  	| timestampz 	| время создание учетной записи                  	|
                | updated_at  	| timestampz 	| время последнего редактирования учетной записи 	|

                Схема:

                ```json
                {
                    id: int,
                    email: string,
                    last_name: string | null,
                    first_name: string | null,
                    middle_name: string | null,
                    is_active: boolean,
                    last_login: string,
                    created_at: string,
                    updated_at: string,
                }
                ```

            2. Неуспешный запрос

                | Поле    	| Тип    	| Описание                          	|
                |---------	|--------	|-----------------------------------	|
                | code    	| int    	| код ошибки                        	|
                | message 	| string 	| человекочитаемое сообщение ошибки 	|

                Схема:

                ```json
                {
                    code: number,
                    message: string,
                }
                ```

4. Удаления пользовотеля

    Удаление пользователя производится только пользователями с определенными правами ("user_delete").

    1. Терминология

        Users - таблица в базе данных, содержащая всех пользователей системы

    2. Этапы
        1. Пользователь обращается к системе
        2. Контроллер приложения перенаправляет запрос в класс представления
            1. Проверяется, есть ли права у пользователя на удаление пользователя из системы. Если прав достаточно, то обращаемся к пункту 2, в ином случае происходит ошибка.
            2. Из таблицы **Users** удаляется пользователь.
        3. Класс представление возвращает ответ пользователю
    3. Конечные методы

        1. DELETE /api/v1/user/{user_id}

            Используется для удаления пользователя из системы

            Параметры запроса:

            | Поле        	| Тип    	| Описание                         	|
            |-------------	|--------	|----------------------------------	|
            | [user_id](#user_id)     	| int    	| идентификатор пользователя       	|

            Тело ответа:

            1. Успешный запрос:

                Тело отсутсвуте

            2. Неуспешный запрос

                | Поле    	| Тип    	| Описание                          	|
                |---------	|--------	|-----------------------------------	|
                | code    	| int    	| код ошибки                        	|
                | message 	| string 	| человекочитаемое сообщение ошибки 	|

                Схема:

                ```json
                {
                    code: number,
                    message: string,
                }
                ```

5. Чтение данных пользователей

    Чтение данных пользователя производится только пользователями с определенными правами ("user_read").

    1. Терминология

        Users - таблица в базе данных, содержащая всех пользователей системы

    2. Этапы
        1. Пользователь обращается к системе
        2. Контроллер приложения перенаправляет запрос в класс представления
            1. Проверяется, есть ли права у пользователя на удаление пользователя из системы. Если прав достаточно, то обращаемся к пункту 2, в ином случае происходит ошибка.
            2. Из таблицы **Users** достается пользователь.
        3. Класс представление возвращает ответ пользователю
    3. Конечные методы

        1. GET /api/v1/user/{user_id}

            Используется для чтения пользователя по уникальному идентификатору

            Параметры запроса:

            | Поле        	| Тип    	| Описание                         	|
            |-------------	|--------	|----------------------------------	|
            | [user_id](#user_id)     	| int    	| идентификатор пользователя       	|

            Тело ответа:

            1. Успешный запрос:

                | Поле        	| Тип        	| Описание                                       	|
                |-------------	|------------	|------------------------------------------------	|
                | id          	| int        	| идентификатор                                  	|
                | email       	| string     	| email пользователя                             	|
                | last_name   	| string     	| (nullable) фамилия пользователя                	|
                | first_name  	| string     	| (nullable) имя пользователя                    	|
                | middle_name 	| string     	| (nullable) отчество пользователя               	|
                | is_active   	| boolean    	| ключ активности учетной записи                 	|
                | last_login  	| timestampz 	| время последнего входа в систему               	|
                | created_at  	| timestampz 	| время создание учетной записи                  	|
                | updated_at  	| timestampz 	| время последнего редактирования учетной записи 	|

                Схема:

                ```json
                {
                    id: int,
                    email: string,
                    last_name: string | null,
                    first_name: string | null,
                    middle_name: string | null,
                    is_active: boolean,
                    last_login: string,
                    created_at: string,
                    updated_at: string,
                }
                ```

            2. Неуспешный запрос

                | Поле    	| Тип    	| Описание                          	|
                |---------	|--------	|-----------------------------------	|
                | code    	| int    	| код ошибки                        	|
                | message 	| string 	| человекочитаемое сообщение ошибки 	|

                Схема:

                ```json
                {
                    code: number,
                    message: string,
                }
                ```
        2. GET /api/v1/users/

            Используется для чтения всех пользователей в системе

            1. Успешный запрос:

                | Поле           	| Тип    	| Описание                         	|
                |----------------	|--------	|----------------------------------	|
                | page           	| int    	| номер страницы                   	|
                | total_elements 	| int    	| общее количество данных          	|
                | data           	| User[] 	| Список пользователей             	|

                Схема:

                ```json
                {
                    page: int,
                    total_elements: int,
                    data: User[],
                }
                ```

            2. Неуспешный запрос

                | Поле    	| Тип    	| Описание                          	|
                |---------	|--------	|-----------------------------------	|
                | code    	| int    	| код ошибки                        	|
                | message 	| string 	| человекочитаемое сообщение ошибки 	|

                Схема:

                ```json
                {
                    code: number,
                    message: string,
                }
                ```

        

